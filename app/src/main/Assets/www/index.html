<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Engine Assembly Steps</title>
    <link rel="stylesheet" href="./styles.css" />

    <!-- Import map pointing to local vendor files -->
    <script type="importmap">
        {
          "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.179.1/build/three.module.js",
      "three/OrbitControls.js": "https://cdn.jsdelivr.net/npm/three@0.179.1/examples/jsm/controls/OrbitControls.js",
      "three/GLTFLoader.js": "https://cdn.jsdelivr.net/npm/three@0.179.1/examples/jsm/loaders/GLTFLoader.js"
          }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mqtt@5.10.1/dist/mqtt.min.js"></script>
    <script >

         const deviceId = localStorage.getItem("deviceId") || "dev-001"; // set per device
         const lineId   = localStorage.getItem("lineId")   || "line-A";

         const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt', {
           // username: "user", password: "pass", // if you enable auth
           protocol: 'wss' ,
           keepalive: 60,
           reconnectPeriod: 2000
         });

         client.on("connect", () => {
           client.subscribe(`all/cmd`);
           client.subscribe(`lines/${lineId}/cmd`);
           client.subscribe(`devices/${deviceId}/cmd`);
           client.subscribe('testtopic/ak/android');
         });

         client.on("message", async (topic, payload) => {
           try {
             const msg = JSON.parse(new TextDecoder().decode(payload));
             console.log(msg);
             if (msg.line == lineId) {
             console.log("changing model")
               await window.updateScene(msg.modelUrl, msg.pointsUrl); // your function
               // optional ack
               // client.publish(`devices/${deviceId}/ack`, JSON.stringify({ok:true,version:msg.version}));
             }
           } catch (e) {
             console.error("Bad message", e);
           }
         });
    </script>

</head>
<body>
<div id="app">
    <div id="overlay">
        <div class="toolbar">
<!--            <div class="modes">-->
<!--                <button data-mode="rotate" class="active">Rotate</button>-->
<!--                <button data-mode="pan">Pan</button>-->
<!--                <button data-mode="select">Select</button>-->
<!--            </div>-->
            <div class="state-controls">
                <label>Set state:</label>
                <button data-state="pending">Pending</button>
                <button data-state="in_progress">In-Progress</button>
                <button data-state="done">Done</button>
                <button data-state="error">Error</button>
            </div>
            <button id="cycle-points">Focus next point</button>
        </div>
        <div id="info">Tap a point in Select mode to change its state.</div>
    </div>
    <div id="point-editor" class="point-editor" style="display:none;">
        <h3>Edit Point</h3>
        <label>Id <input type="text" id="edit-id" /></label><br/>
        <label>Name <input type="text" id="edit-name" /></label><br/>
        <label>X <input type="number" id="edit-x" step="0.001" /></label>
        <label>Y <input type="number" id="edit-y" step="0.001" /></label>
        <label>Z <input type="number" id="edit-z" step="0.001" /></label><br/>
        <label>Radius <input type="number" id="edit-radius" step="0.001" /></label><br/>
        <label>State
            <select id="edit-state">
                <option value="pending">Pending</option>
                <option value="in_progress">In-Progress</option>
                <option value="done">Done</option>
                <option value="error">Error</option>
            </select>
        </label><br/>
        <button id="save-point">Save</button>
        <button id="cancel-point">Cancel</button>
    </div>
</div>

<script type="module" src="./main.js"></script>
</body>
</html>
